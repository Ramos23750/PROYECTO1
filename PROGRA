;
/*Universidad del Valle de Guatemala
IE2023: Programación de Microcontroladores
Autor: Diego Alejandro Ramos Rodas
Proyecto: PROYECTO NO.1 RELOJ
Hardware: ATMega328P
Creado: 03-03-2025
Modificado: 03-03-2025
Descripción: Requisitos del reloj
• Reloj digital que muestre la hora y los minutos (formato de 24 horas, al menos x4 displays
de 7 segmentos)
• Debe de poseer un sistema de alarma (audible) donde se pueda configurar la hora y
minutos.
• La configuración de la hora debe hacer overflow y underflow:
o Si está configurando la hora y el valor de minutos está en 3 se puede hacer la
siguiente secuencia: 03 ? 02 ? 01 ? 00 ? 59 ? 58 ? 57
o La misma funcionalidad debe verse en las horas, días, meses y en la configuración
de la alarma en horas y minutos
• Los dos puntos del centro deben parpadear cada 500ms (implementados con LEDs ó con
los 7 segmentos)
• Los displays deben estar multiplexados
• Función de fecha:
o El reloj debe poder desplegar la fecha en formato: 28/02 (28 de febrero)
(Recuerde que cada mes tiene distinta cantidad de días)
• Cuando se esté en modo de configuración (de hora, fecha ó alarma) deberá haber alguna
indicación de que se está en ese modo (LED, parpadeo de los dígitos, etc)
• El reloj debe funcionar de forma similar a un reloj de pulsera, i.e. los botones funcionan
de forma presionar-y-soltar (antirebotes)
• Tienen que utilizar al menos el Timer0 del Atmega328P y sus respectivas interrupciones
o Puede implementar otros timers y otras interrupciones si lo desea
• Los push-buttons deberán utilizar interrupciones pin-change.
*/
/////////////Encabezado///////////
.include "M328PDEF.INC"
.dseg
/*.org SRAM_START
COUNTUNIT_S: .byte 1
COUNTDEC_S: .byte 1
COUNTUNIT_MIN: .byte 1
COUNTDEC_MIN: .byte 1
COUNTUNIT_H: .byte 1
COUNTDEC_H: .byte 1
UDIA: .byte 1
DDIA: .byte 1
L_DIA: .byte 1
UMES .byte 1
DMES .byte 1
*/
////////////STCK PNTR////////////
START:
	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R17, HIGH(RAMEND)
	OUT SPH, R17
	TABLADEC: .db 0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x67
.cseg
.org 0x0000
	JMP START
.org 0x0008		; iNTERRUPCIONES EN PUERTO C
JMP INT_PCINT
.org OVF0addr
	JMP TIMR0_INT
////////////STCK PNTR////////////
START:
	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R17, HIGH(RAMEND)
	OUT SPH, R17
	TABLADEC: .db 0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x67 
.def CERO = R25
.def UNO = R26
////////////SETUP////////////////
SETUP:
	CLI
	///TIMER///
	LDI R16, (1<<CLKPCE)
	STS CLKPR, R16
	LDI R16, 0b00000100
	STS CLKPR, R16
	LDI R16, (1 << CS01) | (1 << CS00)
	OUT TCCR0B, R16
	LDI R16, 100
	OUT TCNT0, R16
	//Habilitar interrupciones
	LDI R16, (1 << TOIE0)
	STS TIMSK0, R16
	//SALIDAS//
	LDI R16, 0xFF
	OUT DDRD, R16
	LDI R16, 0
	OUT PORTD, R16
	LDI R16, 0b00000111
	OUT DDRC, R16
	LDI R16, 0b00111000
	OUT PORTC, R16
	LDI R16, 0x1F
	OUT DDRB, R16
	LDI R17, 0
	//SETEAR PARA INTERRUPCIONES PIN CHANGE//
	LDI R16, (1<<PCIE1)
	STS PCICR, R16
	LDI R16, (1<<PCINT11) | (1<<PCINT12) | (1<<PCINT13)
	STS PCMSK1, R16		//MASCARA PARA INTERRUPCIONES EN PC3, PC4 Y PC5
	//registros para reiniciar contadores
	LDI ZH, HIGH(TABLADEC << 1)
	LDI ZL, LOW(TABLADEC << 1)
	LDI CERO, 0 
	LDI UNO, 1
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO
	STS COUNTDEC_H, CERO
	STS UDIA, UNO
	STS DDIA, CERO
	STS UMES, UNO
	STS DMES, CERO
	STS MODO, CERO
	STS SEGUNDO, CERO
	SEI
///INICIIO DE LOGICA///
MAIN_LOOP: 
	CPI R20, 100   // R20 = 100 luego de 1s
	BREQ LOOP1
	LDS R21, MODO //EXTRAER EL NO. DEL MODO EN EL CUAL ESTA EL RELOJ
	CPI R21, 0 
	BREQ HORA
	CPI R21, 1
	BREQ FECHA
/*	CPI R21, 2
	BREQ MHORA
	CPI R21, 3
	BREQ MFECHA*/
RMODO: //RETURN DE CONF. DE MODO
	CPI R17, 0
	BREQ DISPL1
	CPI R17, 1
	BREQ DISPL2
	CPI R17, 2
	BREQ DISPL3
	CPI R17, 3
	BREQ DISPL4
	RJMP MAIN_LOOP
DISPL1: 
	RJMP DISP1
DISPL2:
	RJMP DISP2
DISPL3:
	RJMP DISP3
DISPL4:
	RJMP DISP4
LOOP1: //SALTAR A LOOP POR SI BREQ LINE 113 NO LLEGA
	RJMP LOOP
HORA: 
	LDS R21, MODO
	OUT PORTC, R21
	LDS R23, COUNTUNIT_MIN
	STS DIS4, R23
	LDS R23, COUNTDEC_MIN
	STS DIS3, R23
	LDS R23, COUNTUNIT_H
	STS DIS2, R23
	LDS R23, COUNTDEC_H
	STS DIS1, R23
	RJMP RMODO
FECHA:
	LDS R21, MODO
	OUT PORTC, R21
	LDS R23, UDIA
	STS DIS4, R23
	LDS R23, DDIA
	STS DIS3, R23
	LDS R23, UMES
	STS DIS2, R23
	LDS R23, DMES
	STS DIS1, R23
	RJMP RMODO
//OUTPUTS
DISP1:
	OUT PORTD, CERO
	CBI PORTB, 0
	SBI PORTB, 1
	SBI PORTB, 2
	SBI PORTB, 3
	LDI ZH, HIGH(TABLADEC << 1)
	LDI ZL, LOW(TABLADEC << 1)
	LDS R21, DIS1
	ADD ZL, R21
	LPM R21, Z
	OUT PORTD, R21
	INC R17 //alternador para los 4 displays
	ANDI R17, 0x03 //mascara para alternador
	RJMP MAIN_LOOP
DISP2:
	OUT PORTD, CERO
	CPI R20, 50
	BREQ MS500 
R500MS:
	SBI PORTB, 0
	CBI PORTB, 1
	SBI PORTB, 2
	SBI PORTB, 3
	LDI ZH, HIGH(TABLADEC << 1)
	LDI ZL, LOW(TABLADEC << 1)
	LDS R21, DIS2
	ADD ZL, R21
	LPM R21, Z
	OUT PORTD, R21
	LDS R21, SEGUNDO
	CPSE R21, CERO
	SBI PORTD, 7
	INC R17 
	ANDI R17, 0x03 
	RJMP MAIN_LOOP
MS500:
	STS SEGUNDO, UNO
	RJMP R500MS
DISP3:
	OUT PORTD, CERO
	SBI PORTB, 0
	SBI PORTB, 1
	CBI PORTB, 2
	SBI PORTB, 3
	LDI ZH, HIGH(TABLADEC << 1)
	LDI ZL, LOW(TABLADEC << 1)
	LDS R21, DIS3
	ADD ZL, R21
	LPM R21, Z
	OUT PORTD, R21
	INC R17 
	ANDI R17, 0x03 
	RJMP MAIN_LOOP
DISP4: 
	OUT PORTD, CERO
	SBI PORTB, 0
	SBI PORTB, 1
	SBI PORTB, 2
	CBI PORTB, 3
	LDI ZH, HIGH(TABLADEC << 1)
	LDI ZL, LOW(TABLADEC << 1)
	LDS R21, DIS4
	ADD ZL, R21
	LPM R21, Z
	OUT PORTD, R21
	INC R17 
	ANDI R17, 0x03 
	RJMP MAIN_LOOP
LOOP:
	STS SEGUNDO, CERO
	CBI PORTD, 7
	LDI R20, 0
	LDS R21, COUNTUNIT_S
	INC R21
	STS COUNTUNIT_S, R21
	CPI R21, 10
	BREQ LIMITU_S
	RJMP MAIN_LOOP
///INTERRUPCION DEL TIMER
TIMR0_INT:
	LDI R16, 100
	OUT TCNT0, R16
	INC R20
	RETI
//DELMITAR UNIDADES Y DECENAS EN LOS SEGUNDOS
LIMITU_S: 
	LDS R21, COUNTDEC_S
	INC R21
	STS COUNTDEC_S, R21
	STS COUNTUNIT_S, CERO
	CPI R21, 6
	BREQ LIMITD_S
	RJMP MAIN_LOOP
LIMITD_S:
	LDS R21, COUNTUNIT_MIN
	INC R21
	STS COUNTUNIT_MIN, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	CPI R21, 10
	BREQ LIMITU_MIN
	RJMP MAIN_LOOP
//DELIMITAR UNIDADES Y DECENAS EN LOS MINUTOS
LIMITU_MIN:
	LDS R21, COUNTDEC_MIN
	INC R21
	STS COUNTDEC_MIN, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	CPI R21, 6
	BREQ LIMITD_MIN
	RJMP MAIN_LOOP
LIMITD_MIN: 
	LDS R21, COUNTUNIT_H
	INC R21
	STS COUNTUNIT_H, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	CPI R21, 4
	BREQ LIMITU_H2
	CPI R21, 10
	BREQ LIMITU_H1
SI1:
	RJMP MAIN_LOOP
//DELIMITAR UNIDADES Y DECENAS EN LAS HORAS
LIMITU_H1:
	LDS R21, COUNTDEC_H
	INC R21
	STS COUNTDEC_H, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO
	STS COUNTDEC_H, CERO
	RJMP SI1
LIMITU_H2:
	LDS R21, COUNTDEC_H
	CPI R21, 2
	BREQ DIAS_U
	RJMP MAIN_LOOP
///Aumentar dia resetear horas, minutos y segundos///
DIAS_U:  
//aumentar unidades de dia
	LDS R21, UDIA
	INC R21
	LDS R23, UMES
	LDS R24, DMES
	//EXTRAER EL NUMERO  COMPLETO DEL MES ACTUAL
	ADD R23, R24
	//COMPARAR EL MES ACTUAL 
	CPI R23, 1
	BREQ ENERO
	CPI R23, 2
	BREQ FEBRERO
	CPI R23, 3
	BREQ MARZO
	CPI R23, 4
	BREQ ABRIL
	CPI R23, 5
	BREQ MAYO
	CPI R23, 6
	BREQ JUNIO
	CPI R23, 7
	BREQ JULIO
	CPI R23, 8
	BREQ AGOSTO
	CPI R23, 9
	BREQ SEPTIEMBRE
	CPI R23, 10
	BREQ OCTUBRE
	CPI R23, 11
	BREQ NOVIEMBRE
	CPI R23, 12
	BREQ DICIEMBRE
SI2:
	STS NDIAS, R24
	ANDI R24, 0x0F	//EXTRAYENDO LAS UNIDADES DEL NO. DE MESES
	CP R21, R24 //HAY QUE MODIFICAR
	BREQ DIAS_D2
	CPI R21, 9
	BREQ DIAS_D1
SI3:
	STS UDIA, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO 
	STS COUNTDEC_H, CERO
	RJMP MAIN_LOOP
//OBTENER NO. DE DIAS LIMITE PARA CADA MES
ENERO:
	LDI R24, 0x32
	RJMP SI2
FEBRERO:
	LDI R24, 0x29
	RET
MARZO:
	LDI R24, 0x32
	RET
ABRIL:
	LDI R24, 0x31
	RET
MAYO:
	LDI R24, 0x32
	RET
JUNIO:
	LDI R24, 0x31
	RET
JULIO:
	LDI R24, 0x32
	RET
AGOSTO:
	LDI R24, 0x32
	RET
SEPTIEMBRE:
	LDI R24, 0x31
	RET
OCTUBRE:
	LDI R24, 0x32
	RET
NOVIEMBRE:
	LDI R24, 0x31
	RET
DICIEMBRE:
	LDI R24, 0x32
	RET
DIAS_D1:
//aumentar decenas de dia
	LDS R21, DDIA
	INC R21
	STS DDIA, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO
	STS COUNTDEC_H, CERO
	STS UDIA, UNO
	RJMP SI3
DIAS_D2:
//pasar a meses si ya se ha llegado al ultimo dia del mes
	LDS R21, DDIA 
	LDS R23, NDIAS 
	//extraer el segundo digito de los dias del mes
	ANDI R23, 0xF0
	SWAP R23
	CP R21, R23
	BREQ MESES_U
	RJMP MAIN_LOOP
///Aumentar meses y resetear dias, horas, minutos y segundos
MESES_U:
//aumentar unidades de mes
	LDS R21, UMES
	INC R21
	STS UMES, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO
	STS COUNTDEC_H, CERO
	STS UDIA, UNO
	STS DDIA, CERO
	CPI R21, 3
	BREQ MESES_D1
SI4:
	CPI R21, 10
	BREQ MESES_D2
	RJMP MAIN_LOOP
MESES_D1:
	LDS R21, DMES
	INC R21
	STS DMES, R21
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO
	STS COUNTDEC_H, CERO
	STS UDIA, UNO
	STS DDIA, CERO
	STS UMES, UNO
	RJMP SI4
MESES_D2:
	LDS R21, DMES
	CPI R21, 1
	BREQ FIN
	RJMP MAIN_LOOP
//reiniciar todos los contadores
FIN:
	STS COUNTUNIT_S, CERO
	STS COUNTDEC_S, CERO
	STS COUNTUNIT_MIN, CERO
	STS COUNTDEC_MIN, CERO
	STS COUNTUNIT_H, CERO
	STS COUNTDEC_H, CERO
	STS UDIA, UNO
	STS DDIA, CERO
	STS UMES, UNO
	STS DMES, CERO
	RJMP MAIN_LOOP

INT_PCINT:
//VERIFICAR BOTONES DEL PUERTO
		//VERIFICAR EN QUE MODO ESTA
		CPI R21, 0
		BREQ MODO0
		CPI R21, 1
		BREQ MODO1
		CPI R21, 2
		BREQ MODO2
		CPI R21, 3
		BREQ MODO3
		CPI R21, 4
		BREQ MODO4
	RINT:
		SBIS PINC, 3
		RJMP SUMA //BTN PARA AUMENTAR FECHA/HORA
		SBIS PINC, 4
		RJMP C_MODO  //BTN PARA CAMBIAR DE MODO
		SBIS PINC, 5
		RJMP RESTA //BTN PARA DECREMENTAR FECHA/HORA
		RETI
SUMA:
	INC R18
	LDS R21, MODO
	CPI R21, 2
	BREQ SUMA1
	CPI R21, 3
	BREQ SUMA2
RSUMA:
	RJMP MAIN_LOOP
SUMA1:
	STS COUNTUNIT_MIN, R18
	RJMP RSUMA
SUMA2:
	STS UDIA, R18
	RJMP RSUMA
RESTA:
	DEC R18
	LDS R21, MODO
	CPI R21, 2
	BREQ RESTA1
	CPI R21, 3
	BREQ RESTA2
RRESTA:
	RJMP MAIN_LOOP
RESTA1:
	STS COUNTUNIT_MIN, R18
	RJMP RRESTA
RESTA2:
	STS UDIA, R18
	RJMP RRESTA
C_MODO:
	//AUMENTAR EL NO. DE MODO DEL RELOJ
	LDS R21, MODO
	INC R21
	CPI R21, 5
	BREQ R_MODO
R2MODO:
	STS MODO, R21
	RJMP MAIN_LOOP
R_MODO:
	LDI R21, 0
	RJMP R2MODO
MODO0:
	RJMP MAIN_LOOP
MODO1:	
	RJMP MAIN_LOOP
MODO2:
	OUT PORTC, R21
	LDS R18, COUNTUNIT_MIN
	RJMP RINT 
MODO3:
	OUT PORTC, R21
	LDS R18, UDIA
	RJMP RINT
MODO4: 
	OUT PORTC, R21
	RJMP MAIN_LOOP

	

